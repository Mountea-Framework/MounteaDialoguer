const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-x7q8uQWk.js","./index-6Auvw_ln.js","./index-CK92ER0f.css","./_commonjs-dynamic-modules-TDtrdbi3.js","./FileSaver.min-42lW9nZe.js","./categoryStore-1JoM0Wp-.js","./index-BaQFQbvq.js"])))=>i.map(i=>d[i]);
import{r as k,ac as xe,ad as ve,l as Q,ae as C,d as i,w as m,j as me,a as ye}from"./index-6Auvw_ln.js";const Ie=(t,o,e,a)=>{var r,p,y,u;const s=[e,{code:o,...a||{}}];if((p=(r=t==null?void 0:t.services)==null?void 0:r.logger)!=null&&p.forward)return t.services.logger.forward(s,"warn","react-i18next::",!0);H(s[0])&&(s[0]=`react-i18next:: ${s[0]}`),(u=(y=t==null?void 0:t.services)==null?void 0:y.logger)!=null&&u.warn?t.services.logger.warn(...s):console!=null&&console.warn&&console.warn(...s)},le={},oe=(t,o,e,a)=>{H(e)&&le[e]||(H(e)&&(le[e]=new Date),Ie(t,o,e,a))},he=(t,o)=>()=>{if(t.isInitialized)o();else{const e=()=>{setTimeout(()=>{t.off("initialized",e)},0),o()};t.on("initialized",e)}},re=(t,o,e)=>{t.loadNamespaces(o,he(t,e))},ue=(t,o,e,a)=>{if(H(e)&&(e=[e]),t.options.preload&&t.options.preload.indexOf(o)>-1)return re(t,e,a);e.forEach(s=>{t.options.ns.indexOf(s)<0&&t.options.ns.push(s)}),t.loadLanguages(o,he(t,a))},Pe=(t,o,e={})=>!o.languages||!o.languages.length?(oe(o,"NO_LANGUAGES","i18n.languages were undefined or empty",{languages:o.languages}),!0):o.hasLoadedNamespace(t,{lng:e.lng,precheck:(a,s)=>{if(e.bindI18n&&e.bindI18n.indexOf("languageChanging")>-1&&a.services.backendConnector.backend&&a.isLanguageChangingTo&&!s(a.isLanguageChangingTo,t))return!1}}),H=t=>typeof t=="string",Ne=t=>typeof t=="object"&&t!==null,Le=k.createContext();class Fe{constructor(){this.usedNamespaces={}}addUsedNamespaces(o){o.forEach(e=>{this.usedNamespaces[e]||(this.usedNamespaces[e]=!0)})}getUsedNamespaces(){return Object.keys(this.usedNamespaces)}}const Re=(t,o)=>{const e=k.useRef();return k.useEffect(()=>{e.current=t},[t,o]),e.current},Se=(t,o,e,a)=>t.getFixedT(o,e,a),Oe=(t,o,e,a)=>k.useCallback(Se(t,o,e,a),[t,o,e,a]),We=(t,o={})=>{var U,N,B,g;const{i18n:e}=o,{i18n:a,defaultNS:s}=k.useContext(Le)||{},r=e||a||xe();if(r&&!r.reportNamespaces&&(r.reportNamespaces=new Fe),!r){oe(r,"NO_I18NEXT_INSTANCE","useTranslation: You will need to pass in an i18next instance by using initReactI18next");const w=(l,f)=>H(f)?f:Ne(f)&&H(f.defaultValue)?f.defaultValue:Array.isArray(l)?l[l.length-1]:l,h=[w,{},!1];return h.t=w,h.i18n={},h.ready=!1,h}(U=r.options.react)!=null&&U.wait&&oe(r,"DEPRECATED_OPTION","useTranslation: It seems you are still using the old wait option, you may migrate to the new useSuspense behaviour.");const p={...ve(),...r.options.react,...o},{useSuspense:y,keyPrefix:u}=p;let c=s||((N=r.options)==null?void 0:N.defaultNS);c=H(c)?[c]:c||["translation"],(g=(B=r.reportNamespaces).addUsedNamespaces)==null||g.call(B,c);const A=(r.isInitialized||r.initializedStoreOnce)&&c.every(w=>Pe(w,r,p)),j=Oe(r,o.lng||null,p.nsMode==="fallback"?c:c[0],u),E=()=>j,S=()=>Se(r,o.lng||null,p.nsMode==="fallback"?c:c[0],u),[$,L]=k.useState(E);let P=c.join();o.lng&&(P=`${o.lng}${P}`);const T=Re(P),b=k.useRef(!0);k.useEffect(()=>{const{bindI18n:w,bindI18nStore:h}=p;b.current=!0,!A&&!y&&(o.lng?ue(r,o.lng,c,()=>{b.current&&L(S)}):re(r,c,()=>{b.current&&L(S)})),A&&T&&T!==P&&b.current&&L(S);const l=()=>{b.current&&L(S)};return w&&(r==null||r.on(w,l)),h&&(r==null||r.store.on(h,l)),()=>{b.current=!1,r&&w&&(w==null||w.split(" ").forEach(f=>r.off(f,l))),h&&r&&h.split(" ").forEach(f=>r.store.off(f,l))}},[r,P]),k.useEffect(()=>{b.current&&A&&L(E)},[r,u,A]);const D=[$,r,A];if(D.t=$,D.i18n=r,D.ready=A,A||!A&&!y)return D;throw new Promise(w=>{o.lng?ue(r,o.lng,c,()=>w()):re(r,c,()=>w())})},ge=t=>{let o;const e=new Set,a=(c,A)=>{const j=typeof c=="function"?c(o):c;if(!Object.is(j,o)){const E=o;o=A??(typeof j!="object"||j===null)?j:Object.assign({},o,j),e.forEach(S=>S(o,E))}},s=()=>o,y={setState:a,getState:s,getInitialState:()=>u,subscribe:c=>(e.add(c),()=>e.delete(c))},u=o=t(a,s,y);return y},Ce=(t=>t?ge(t):ge),$e=t=>t;function Te(t,o=$e){const e=Q.useSyncExternalStore(t.subscribe,Q.useCallback(()=>o(t.getState()),[t,o]),Q.useCallback(()=>o(t.getInitialState()),[t,o]));return Q.useDebugValue(e),e}const pe=t=>{const o=Ce(t),e=a=>Te(o,a);return Object.assign(e,o),e},je=(t=>t?pe(t):pe),qe=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Je(t){return typeof t=="string"&&qe.test(t)}const O=[];for(let t=0;t<256;++t)O.push((t+256).toString(16).slice(1));function Ae(t,o=0){return(O[t[o+0]]+O[t[o+1]]+O[t[o+2]]+O[t[o+3]]+"-"+O[t[o+4]]+O[t[o+5]]+"-"+O[t[o+6]]+O[t[o+7]]+"-"+O[t[o+8]]+O[t[o+9]]+"-"+O[t[o+10]]+O[t[o+11]]+O[t[o+12]]+O[t[o+13]]+O[t[o+14]]+O[t[o+15]]).toLowerCase()}function Ze(t,o=0){const e=Ae(t,o);if(!Je(e))throw TypeError("Stringified UUID is invalid");return e}let ae;const Ue=new Uint8Array(16);function Me(){if(!ae){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ae=crypto.getRandomValues.bind(crypto)}return ae(Ue)}const Ve=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),fe={randomUUID:Ve};function W(t,o,e){var s;if(fe.randomUUID&&!o&&!t)return fe.randomUUID();t=t||{};const a=t.random??((s=t.rng)==null?void 0:s.call(t))??Me();if(a.length<16)throw new Error("Random bytes length must be >= 16");if(a[6]=a[6]&15|64,a[8]=a[8]&63|128,o){if(e=e||0,e<0||e+16>o.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let r=0;r<16;++r)o[e+r]=a[r];return o}return Ae(a)}const He=je((t,o)=>({projects:[],currentProject:null,isLoading:!1,error:null,loadProjects:async()=>{t({isLoading:!0,error:null});try{const e=await i.projects.toArray(),a=await Promise.all(e.map(async s=>{const r=await i.dialogues.where("projectId").equals(s.id).count();return{...s,dialogueCount:r}}));t({projects:a,isLoading:!1})}catch(e){console.error("Error loading projects:",e),m({variant:"error",title:"Failed to Load Projects",description:e.message||"An unexpected error occurred"}),t({error:e.message,isLoading:!1})}},createProject:async e=>{t({isLoading:!0,error:null});try{const a=new Date().toISOString(),r={id:W(),...e,createdAt:a,modifiedAt:a};return await i.projects.add(r),await o().loadProjects(),m({variant:"success",title:"Project Created",description:`${e.name} has been created successfully`}),r}catch(a){throw console.error("Error creating project:",a),m({variant:"error",title:"Failed to Create Project",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},updateProject:async(e,a)=>{t({isLoading:!0,error:null});try{await i.projects.update(e,{...a,modifiedAt:new Date().toISOString()}),await o().loadProjects(),m({variant:"success",title:"Project Updated",description:"Project has been updated successfully"})}catch(s){throw console.error("Error updating project:",s),m({variant:"error",title:"Failed to Update Project",description:s.message||"An unexpected error occurred"}),t({error:s.message,isLoading:!1}),s}},deleteProject:async e=>{t({isLoading:!0,error:null});try{await i.transaction("rw",[i.projects,i.dialogues,i.participants,i.categories,i.decorators],async()=>{await i.projects.delete(e),await i.dialogues.where("projectId").equals(e).delete(),await i.participants.where("projectId").equals(e).delete(),await i.categories.where("projectId").equals(e).delete(),await i.decorators.where("projectId").equals(e).delete()}),await o().loadProjects(),m({variant:"success",title:"Project Deleted",description:"Project and all related data have been deleted"})}catch(a){throw console.error("Error deleting project:",a),m({variant:"error",title:"Failed to Delete Project",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},setCurrentProject:async e=>{t({isLoading:!0,error:null});try{const a=await i.projects.get(e);t({currentProject:a,isLoading:!1})}catch(a){throw console.error("Error setting current project:",a),m({variant:"error",title:"Failed to Load Project",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},clearCurrentProject:()=>{t({currentProject:null})},exportProject:async e=>{try{const a=(await C(async()=>{const{default:g}=await import("./jszip.min-x7q8uQWk.js").then(w=>w.j);return{default:g}},__vite__mapDeps([0,1,2,3]),import.meta.url)).default,{saveAs:s}=await C(async()=>{const{saveAs:g}=await import("./FileSaver.min-42lW9nZe.js").then(w=>w.F);return{saveAs:g}},__vite__mapDeps([4,1,2]),import.meta.url),r=await i.projects.get(e);if(!r)throw new Error("Project not found");const p=await i.dialogues.where("projectId").equals(e).toArray(),y=await i.categories.where("projectId").equals(e).toArray(),u=await i.participants.where("projectId").equals(e).toArray(),c=await i.decorators.where("projectId").equals(e).toArray(),{useCategoryStore:A}=await C(async()=>{const{useCategoryStore:g}=await import("./categoryStore-1JoM0Wp-.js");return{useCategoryStore:g}},__vite__mapDeps([5,1,2]),import.meta.url),j=new Map;y.forEach(g=>{const w=A.getState().buildCategoryPath(g.id,y);j.set(g.name,w)});const E={projectGuid:r.id,projectName:r.name,projectDescription:r.description||"",version:r.version||"1.0.0",createdAt:r.createdAt,modifiedAt:r.modifiedAt||new Date().toISOString()},S=y.map(g=>({name:g.name,fullPath:j.get(g.name)||g.name})),$=u.map(g=>({name:g.name,fullPath:j.get(g.category)||g.category})),L=c.map(({id:g,projectId:w,createdAt:h,modifiedAt:l,...f})=>f),P=new a;P.file("projectData.json",JSON.stringify(E,null,2)),P.file("categories.json",JSON.stringify(S,null,2)),P.file("participants.json",JSON.stringify($,null,2)),P.file("decorators.json",JSON.stringify(L,null,2));const T=P.folder("dialogues"),{useDialogueStore:b}=await C(async()=>{const{useDialogueStore:g}=await Promise.resolve().then(()=>we);return{useDialogueStore:g}},void 0,import.meta.url),D=b.getState();let U=0,N=0;for(const g of p)try{console.log(`Exporting dialogue: ${g.name} (${g.id})`);const w=await D.exportDialogueAsBlob(g.id),h=g.name.replace(/[^a-z0-9]/gi,"_");T.file(`${h}.mnteadlg`,w),U++,console.log(`Successfully exported dialogue: ${g.name}`)}catch(w){N++,console.error(`Failed to export dialogue ${g.name}:`,w),m({variant:"error",title:`Failed to Export Dialogue: ${g.name}`,description:w.message})}console.log(`Exported ${U} dialogues, ${N} failed`);const B=await P.generateAsync({type:"blob"});s(B,`${r.name}.mnteadlgproj`),m({variant:"success",title:"Project Exported",description:`${r.name}.mnteadlgproj has been exported`})}catch(a){throw console.error("Error exporting project:",a),m({variant:"error",title:"Failed to Export Project",description:a.message||"An unexpected error occurred"}),a}},importProject:async e=>{var a,s,r,p;try{const u=await(await C(async()=>{const{default:l}=await import("./jszip.min-x7q8uQWk.js").then(f=>f.j);return{default:l}},__vite__mapDeps([0,1,2,3]),import.meta.url)).default.loadAsync(e),c=await((a=u.file("projectData.json"))==null?void 0:a.async("text")),A=await((s=u.file("participants.json"))==null?void 0:s.async("text")),j=await((r=u.file("categories.json"))==null?void 0:r.async("text")),E=await((p=u.file("decorators.json"))==null?void 0:p.async("text"));if(!c)throw new Error("Invalid project file: missing projectData.json");const S=JSON.parse(c),$=A?JSON.parse(A):[],L=j?JSON.parse(j):[],P=E?JSON.parse(E):[],{v4:T}=await C(async()=>{const{v4:l}=await import("./index-BaQFQbvq.js");return{v4:l}},__vite__mapDeps([6,1,2]),import.meta.url),b=T(),D=new Date().toISOString(),U={id:b,name:S.projectName,description:S.description||"",createdAt:D,modifiedAt:D};await i.projects.add(U);const N=new Map,{useCategoryStore:B}=await C(async()=>{const{useCategoryStore:l}=await import("./categoryStore-1JoM0Wp-.js");return{useCategoryStore:l}},__vite__mapDeps([5,1,2]),import.meta.url);for(const l of L){const f=T(),M={id:f,name:l.name,parentCategoryId:null,projectId:b,createdAt:D,modifiedAt:D};await i.categories.add(M),N.set(l.id,f)}for(const l of L)if(l.parentCategoryId){const f=N.get(l.id),M=N.get(l.parentCategoryId);f&&M&&await i.categories.update(f,{parentCategoryId:M})}for(const l of $){const f=T();await i.participants.add({id:f,name:l.name,category:l.category,projectId:b,createdAt:D,modifiedAt:D})}for(const l of P){const f=T();await i.decorators.add({id:f,name:l.name,type:l.type,values:l.values||{},projectId:b,createdAt:D,modifiedAt:D})}const{useDialogueStore:g}=await C(async()=>{const{useDialogueStore:l}=await Promise.resolve().then(()=>we);return{useDialogueStore:l}},void 0,import.meta.url),w=g.getState(),h=u.folder("dialogues");if(h){const l=[];h.forEach((f,M)=>{f.endsWith(".mnteadlg")&&!M.dir&&l.push({path:f,file:M})});for(const{path:f,file:M}of l)try{const n=await M.async("blob"),v=new File([n],f);await w.importDialogue(b,v)}catch(n){console.error(`Failed to import dialogue ${f}:`,n),m({variant:"error",title:"Failed to Import Dialogue",description:`${f}: ${n.message}`})}}return await o().loadProjects(),m({variant:"success",title:"Project Imported",description:`${U.name} has been imported successfully`}),b}catch(y){console.error("Error importing project:",y),m({variant:"error",title:"Failed to Import Project",description:y.message||"An unexpected error occurred"})}}})),ze=je((t,o)=>({dialogues:[],currentDialogue:null,nodes:[],edges:[],isLoading:!1,error:null,loadDialogues:async e=>{t({isLoading:!0,error:null});try{const a=e?await i.dialogues.where("projectId").equals(e).toArray():await i.dialogues.toArray(),s=await Promise.all(a.map(async r=>{const p=await i.nodes.where("dialogueId").equals(r.id).count();return{...r,nodeCount:p}}));t({dialogues:s,isLoading:!1})}catch(a){console.error("Error loading dialogues:",a),m({variant:"error",title:"Failed to Load Dialogues",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1})}},createDialogue:async e=>{t({isLoading:!0,error:null});try{const a=new Date().toISOString(),r={id:W(),...e,createdAt:a,modifiedAt:a};return await i.dialogues.add(r),await o().loadDialogues(e.projectId),m({variant:"success",title:"Dialogue Created",description:`${e.name} has been created successfully`}),r}catch(a){throw console.error("Error creating dialogue:",a),m({variant:"error",title:"Failed to Create Dialogue",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},updateDialogue:async(e,a)=>{t({isLoading:!0,error:null});try{await i.dialogues.update(e,{...a,modifiedAt:new Date().toISOString()});const s=await i.dialogues.get(e);await o().loadDialogues(s.projectId),m({variant:"success",title:"Dialogue Updated",description:"Dialogue has been updated successfully"})}catch(s){throw console.error("Error updating dialogue:",s),m({variant:"error",title:"Failed to Update Dialogue",description:s.message||"An unexpected error occurred"}),t({error:s.message,isLoading:!1}),s}},deleteDialogue:async e=>{t({isLoading:!0,error:null});try{const a=await i.dialogues.get(e);await i.transaction("rw",[i.dialogues,i.nodes,i.edges],async()=>{await i.dialogues.delete(e),await i.nodes.where("dialogueId").equals(e).delete(),await i.edges.where("dialogueId").equals(e).delete()}),await o().loadDialogues(a.projectId),m({variant:"success",title:"Dialogue Deleted",description:"Dialogue and all nodes have been deleted"})}catch(a){throw console.error("Error deleting dialogue:",a),m({variant:"error",title:"Failed to Delete Dialogue",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},setCurrentDialogue:async e=>{t({isLoading:!0,error:null});try{const a=await i.dialogues.get(e),s=await i.nodes.where("dialogueId").equals(e).toArray(),r=await i.edges.where("dialogueId").equals(e).toArray();t({currentDialogue:a,nodes:s,edges:r,isLoading:!1})}catch(a){throw console.error("Error setting current dialogue:",a),m({variant:"error",title:"Failed to Load Dialogue",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},updateNodes:async(e,a)=>{t({isLoading:!0,error:null});try{await i.transaction("rw",i.nodes,async()=>{await i.nodes.where("dialogueId").equals(e).delete(),await i.nodes.bulkAdd(a.map(s=>({...s,dialogueId:e})))}),t({nodes:a,isLoading:!1})}catch(s){throw console.error("Error updating nodes:",s),m({variant:"error",title:"Failed to Update Nodes",description:s.message||"An unexpected error occurred"}),t({error:s.message,isLoading:!1}),s}},updateEdges:async(e,a)=>{t({isLoading:!0,error:null});try{await i.transaction("rw",i.edges,async()=>{await i.edges.where("dialogueId").equals(e).delete(),await i.edges.bulkAdd(a.map(s=>({...s,dialogueId:e})))}),t({edges:a,isLoading:!1})}catch(s){throw console.error("Error updating edges:",s),m({variant:"error",title:"Failed to Update Edges",description:s.message||"An unexpected error occurred"}),t({error:s.message,isLoading:!1}),s}},saveDialogueGraph:async(e,a,s,r)=>{t({isLoading:!0,error:null});try{const{prepareAudioForStorage:p}=await C(async()=>{const{prepareAudioForStorage:u}=await import("./audioUtils-CfvGLBIu.js");return{prepareAudioForStorage:u}},[],import.meta.url),y=await Promise.all(a.map(async u=>{var c;if((c=u.data)!=null&&c.dialogueRows){const A=await Promise.all(u.data.dialogueRows.map(async j=>{var E;if((E=j.audioFile)!=null&&E.blob){const S=await p(j.audioFile);return{...j,audioFile:S}}return j}));return{...u,data:{...u.data,dialogueRows:A}}}return u}));await i.transaction("rw",[i.nodes,i.edges,i.dialogues],async()=>{await i.nodes.where("dialogueId").equals(e).delete(),await i.edges.where("dialogueId").equals(e).delete(),y.length>0&&await i.nodes.bulkAdd(y.map(u=>({...u,dialogueId:e}))),s.length>0&&await i.edges.bulkAdd(s.map(u=>({...u,dialogueId:e}))),await i.dialogues.update(e,{modifiedAt:new Date().toISOString(),viewport:r||{x:0,y:0,zoom:1}})}),t({nodes:a,edges:s,isLoading:!1})}catch(p){throw console.error("Error saving dialogue graph:",p),m({variant:"error",title:"Failed to Save Dialogue",description:p.message||"An unexpected error occurred"}),t({error:p.message,isLoading:!1}),p}},loadDialogueGraph:async e=>{t({isLoading:!0,error:null});try{const{restoreAudioFromStorage:a}=await C(async()=>{const{restoreAudioFromStorage:c}=await import("./audioUtils-CfvGLBIu.js");return{restoreAudioFromStorage:c}},[],import.meta.url),s=await i.nodes.where("dialogueId").equals(e).toArray(),r=await i.edges.where("dialogueId").equals(e).toArray(),p=await i.dialogues.get(e),y=(p==null?void 0:p.viewport)||{x:0,y:0,zoom:1},u=s.map(c=>{var A;if((A=c.data)!=null&&A.dialogueRows){const j=c.data.dialogueRows.map(E=>{var S;if((S=E.audioFile)!=null&&S.base64){const $=a(E.audioFile);return{...E,audioFile:$}}return E});return{...c,data:{...c.data,dialogueRows:j}}}return c});return t({nodes:u,edges:r,isLoading:!1}),{nodes:u,edges:r,viewport:y}}catch(a){throw console.error("Error loading dialogue graph:",a),m({variant:"error",title:"Failed to Load Dialogue Graph",description:a.message||"An unexpected error occurred"}),t({error:a.message,isLoading:!1}),a}},clearCurrentDialogue:()=>{t({currentDialogue:null,nodes:[],edges:[]})},exportDialogue:async e=>{try{const{saveAs:a}=await C(async()=>{const{saveAs:p}=await import("./FileSaver.min-42lW9nZe.js").then(y=>y.F);return{saveAs:p}},__vite__mapDeps([4,1,2]),import.meta.url),s=await i.dialogues.get(e);if(!s)throw new Error("Dialogue not found");const r=await o().exportDialogueAsBlob(e);a(r,`${s.name}.mnteadlg`),m({variant:"success",title:"Dialogue Exported",description:`${s.name}.mnteadlg has been exported`})}catch(a){throw console.error("Error exporting dialogue:",a),m({variant:"error",title:"Failed to Export Dialogue",description:a.message||"An unexpected error occurred"}),a}},exportDialogueAsBlob:async e=>{var a;try{console.log(`[exportDialogueAsBlob] Starting export for dialogue: ${e}`);const s=(await C(async()=>{const{default:n}=await import("./jszip.min-x7q8uQWk.js").then(v=>v.j);return{default:n}},__vite__mapDeps([0,1,2,3]),import.meta.url)).default,r=await i.dialogues.get(e);if(!r)throw new Error(`Dialogue not found: ${e}`);console.log(`[exportDialogueAsBlob] Found dialogue: ${r.name}`);const p=await i.nodes.where("dialogueId").equals(e).toArray(),y=await i.edges.where("dialogueId").equals(e).toArray(),{restoreAudioFromStorage:u}=await C(async()=>{const{restoreAudioFromStorage:n}=await import("./audioUtils-CfvGLBIu.js");return{restoreAudioFromStorage:n}},[],import.meta.url),c=p.map(n=>{var v;if((v=n.data)!=null&&v.dialogueRows){const F=n.data.dialogueRows.map(_=>{var R;if((R=_.audioFile)!=null&&R.base64){const J=u(_.audioFile);return{..._,audioFile:J}}return _});return{...n,data:{...n.data,dialogueRows:F}}}return n});if(console.log(`[exportDialogueAsBlob] Found ${c.length} nodes and ${y.length} edges`),!c.find(n=>n.id==="00000000-0000-0000-0000-000000000001"))throw new Error("Export failed: Start Node (00000000-0000-0000-0000-000000000001) is missing from the dialogue");const j=new Set,E=new Set,S=[],$=[];c.forEach(n=>{var v,F,_;(v=n.data)!=null&&v.participant&&j.add(n.data.participant),(F=n.data)!=null&&F.dialogueRows&&n.data.dialogueRows.forEach(R=>{$.push({id:R.id,text:R.text||"",audioPath:R.audioFile?`audio/${R.id}/`:null,nodeId:n.id,duration:R.duration||0})}),(_=n.data)!=null&&_.decorators&&n.data.decorators.forEach(R=>{S.push({...R,nodeId:n.id})})});const L=await i.categories.where("projectId").equals(r.projectId).toArray(),T=(await i.participants.where("projectId").equals(r.projectId).toArray()).filter(n=>j.has(n.name)),b=new Set(T.map(n=>n.category)),D=L.filter(n=>b.has(n.name)),{useCategoryStore:U}=await C(async()=>{const{useCategoryStore:n}=await import("./categoryStore-1JoM0Wp-.js");return{useCategoryStore:n}},__vite__mapDeps([5,1,2]),import.meta.url),N=new Map;L.forEach(n=>{const v=U.getState().buildCategoryPath(n.id,L);N.set(n.name,v)});const B={dialogueGuid:r.id,dialogueName:r.name,modifiedOnDate:r.modifiedAt||new Date().toISOString()},g=D.map(n=>({name:n.name,fullPath:N.get(n.name)||n.name})),w=T.map(n=>({name:n.name,fullPath:N.get(n.category)||n.category})),h=new s,l=c.map(n=>{var v;if((v=n.data)!=null&&v.dialogueRows){const F=n.data.dialogueRows.map(_=>{const{audioFile:R,...J}=_;return J});return{...n,data:{...n.data,dialogueRows:F}}}return n});h.file("dialogueData.json",JSON.stringify(B,null,2)),h.file("categories.json",JSON.stringify(g,null,2)),h.file("participants.json",JSON.stringify(w,null,2)),h.file("nodes.json",JSON.stringify(l,null,2)),h.file("edges.json",JSON.stringify(y,null,2)),h.file("dialogueRows.json",JSON.stringify($,null,2)),h.file("decorators.json",JSON.stringify(S,null,2));const f=h.folder("audio");for(const n of $)if(n.audioPath){const v=c.find(F=>{var _,R;return(R=(_=F.data)==null?void 0:_.dialogueRows)==null?void 0:R.some(J=>J.id===n.id)});if(v){const F=v.data.dialogueRows.find(_=>_.id===n.id);(a=F==null?void 0:F.audioFile)!=null&&a.blob&&f.folder(n.id).file(F.audioFile.name,F.audioFile.blob)}}return await h.generateAsync({type:"blob"})}catch(s){throw console.error("Error exporting dialogue as blob:",s),s}},importDialogue:async(e,a)=>{var s,r,p,y,u,c,A,j;try{const S=await(await C(async()=>{const{default:d}=await import("./jszip.min-x7q8uQWk.js").then(x=>x.j);return{default:d}},__vite__mapDeps([0,1,2,3]),import.meta.url)).default.loadAsync(a),$=await((s=S.file("dialogueData.json"))==null?void 0:s.async("text")),L=await((r=S.file("categories.json"))==null?void 0:r.async("text")),P=await((p=S.file("participants.json"))==null?void 0:p.async("text")),T=await((y=S.file("decorators.json"))==null?void 0:y.async("text")),b=await((u=S.file("nodes.json"))==null?void 0:u.async("text")),D=await((c=S.file("edges.json"))==null?void 0:c.async("text")),U=await((A=S.file("dialogueRows.json"))==null?void 0:A.async("text"));if(!$||!b||!D)throw new Error("Invalid dialogue file: missing required files");const N=JSON.parse($),B=L?JSON.parse(L):[],g=P?JSON.parse(P):[],w=T?JSON.parse(T):[],h=JSON.parse(b),l=JSON.parse(D),f=U?JSON.parse(U):[];if(!h.find(d=>d.id==="00000000-0000-0000-0000-000000000001"))throw new Error("Import failed: Start Node (00000000-0000-0000-0000-000000000001) is missing from the dialogue file");const{useCategoryStore:n}=await C(async()=>{const{useCategoryStore:d}=await import("./categoryStore-1JoM0Wp-.js");return{useCategoryStore:d}},__vite__mapDeps([5,1,2]),import.meta.url),v=n.getState(),F=await i.categories.where("projectId").equals(e).toArray(),_=new Map;F.forEach(d=>{const x=v.buildCategoryPath(d.id,F);_.set(x,d)});const R=new Map,J=new Date().toISOString();for(const d of B){const x=d.fullPath;if(!_.has(x)){const V=x.split(".");let I=null,z="";for(const G of V)if(z=z?`${z}.${G}`:G,_.has(z))I=_.get(z).id;else{const q={id:W(),name:G,parentCategoryId:I,projectId:e,createdAt:J,modifiedAt:J};await i.categories.add(q),_.set(z,q),I=q.id}}R.set(x,d.name)}const Ee=await i.participants.where("projectId").equals(e).toArray(),ie=new Set(Ee.map(d=>d.name)),_e=new Map;for(const d of g){if(!ie.has(d.name)){const x=R.get(d.fullPath)||((j=_.get(d.fullPath))==null?void 0:j.name);if(!x)throw new Error(`Category not found for participant ${d.name}: ${d.fullPath}`);const V={id:W(),name:d.name,category:x,projectId:e,createdAt:J,modifiedAt:J};await i.participants.add(V),ie.add(d.name)}_e.set(d.name,d.name)}const be=await i.decorators.where("projectId").equals(e).toArray(),X=new Map;be.forEach(d=>{X.set(d.name,d)});const se=new Set;w.forEach(d=>{se.add(d.name)});for(const d of se)if(!X.has(d)){const x={id:W(),name:d,type:"",properties:[],projectId:e,createdAt:J,modifiedAt:J};await i.decorators.add(x),X.set(d,x)}if(!N.dialogueName||!N.dialogueName.trim())throw new Error("Invalid dialogue name");const De=await i.dialogues.where("projectId").equals(e).toArray();let Y=N.dialogueName,ne=1;for(;De.some(d=>d.name===Y);)Y=`${N.dialogueName} (${ne})`,ne++;const ee=W(),de={id:ee,projectId:e,name:Y,description:"",nodeCount:h.length,createdAt:J,modifiedAt:J};await i.dialogues.add(de);const K=new Map;for(const d of h){const x=d.id,V=d.type==="startNode"?"00000000-0000-0000-0000-000000000001":W();K.set(x,V);const I={...d.data};I.participant&&(typeof I.participant=="string"?I.participant=I.participant:I.participant.name&&(I.participant=I.participant.name)),I.decorators&&(I.decorators=I.decorators.map(q=>{const Z=X.get(q.name);return{id:(Z==null?void 0:Z.id)||q.id,name:q.name,values:q.values||{}}}));const z=I.dialogueRows||[],G={id:V,dialogueId:ee,type:d.type,position:d.position,data:I};await i.nodes.add(G)}for(const d of l){const x={id:W(),dialogueId:ee,source:K.get(d.source),target:K.get(d.target),sourceHandle:d.sourceHandle,targetHandle:d.targetHandle,markerEnd:d.markerEnd};await i.edges.add(x)}const ce=S.folder("audio");if(ce){for(const d of f)if(d.audioPath){const x=ce.folder(d.id);if(x){const V=Object.keys(x.files).filter(I=>!I.endsWith("/"));if(V.length>0){const z=await x.files[V[0]].async("blob"),G=K.get(d.nodeId);if(G){const q=await i.nodes.get(G);if(q&&q.data.dialogueRows){const Z=q.data.dialogueRows.findIndex(te=>te.text===d.text);if(Z!==-1){const te={id:W(),name:V[0].split("/").pop(),type:z.type,size:z.size,blob:z,path:`audio/${d.id}/${V[0].split("/").pop()}`};q.data.dialogueRows[Z].audioFile=te,q.data.dialogueRows[Z].duration=d.duration,await i.nodes.update(G,{data:q.data})}}}}}}}return await o().loadDialogues(e),m({variant:"success",title:"Dialogue Imported",description:`${Y} has been imported successfully`}),de}catch(E){console.error("Error importing dialogue:",E),m({variant:"error",title:"Failed to Import Dialogue",description:E.message||"An unexpected error occurred"})}}})),we=Object.freeze(Object.defineProperty({__proto__:null,useDialogueStore:ze},Symbol.toStringTag,{value:"Module"})),ke=k.forwardRef(({className:t,type:o,...e},a)=>me.jsx("input",{type:o,className:ye("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...e}));ke.displayName="Input";const Be=k.forwardRef(({className:t,...o},e)=>me.jsx("label",{ref:e,className:ye("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",t),...o}));Be.displayName="Label";export{ke as I,Be as L,He as a,ze as b,je as c,Je as d,Ae as e,Me as r,Ze as s,We as u,W as v};
